# 整理番号管理Webシステム v1.3.1

大学の文化祭やイベントでの混雑緩和を目的とした、Webベースの整理券発券・呼び出しシステムです。
Rust言語とPaaS「Shuttle」を用いることで、**開発から運用まで完全無料**、かつ**高い堅牢性**を実現しています。

## 📖 概要

*   **出展者側**: PCやタブレットから整理番号を発券し、QRコードを表示。呼び出し管理画面からワンタップでステータス更新が可能。
*   **来場者側**: スマホでQRコードを読み取るだけで、専用アプリ不要で待ち状況を確認。順番が近づくと自動で画面が更新され通知されます。
*   **分析機能**: 発券・呼出・完了の時刻ログをCSVで出力することが可能。

## ✨ 主な機能

1.  **整理券発券 (受付)**
    *   人数を入力してワンクリックで発券。
    *   来場者読み取り用のQRコードを即座に生成・表示。
    *   3桁の整理番号（999を超えると1へループ）。
2.  **呼び出し管理 (誘導)**
    *   スマホ・タブレットに最適化されたカード型レイアウト。
    *   待機中人数のリアルタイム把握。
    *   「呼び出し」「完了」のステータス変更。
3.  **来場者用マイページ**
    *   「あと何組待ちか」をリアルタイム表示（HTMXによる自動更新）。
    *   呼び出し時に画面デザインが変化し、視覚的に通知。
4.  **データ分析**
    *   全データをCSV形式でダウンロード可能。
    *   タイムスタンプ記録による回転率・ピークタイム分析。
5.  **セキュリティ**
    *   管理画面へのBasic認証。
    *   CSRF対策（Origin/Refererチェック）。
    *   タイミング攻撃耐性のある認証比較。

## 🛠 技術スタック

*   **言語**: Rust (v1.xx)
*   **Webフレームワーク**: Axum
*   **インフラ/デプロイ**: Shuttle.rs (PaaS)
*   **データベース**: PostgreSQL (Shuttle Shared DB)
*   **フロントエンド**: HTML, CSS, Askama (テンプレート), HTMX (非同期通信)

## 🚀 セットアップとデプロイ

### 前提条件
*   Rust / Cargo がインストールされていること
*   Docker Desktop がインストールされていること（ローカル開発用）
*   `cargo-shuttle` がインストールされていること (`cargo install cargo-shuttle`)

### 1. 環境設定 (Secrets.toml)
プロジェクトルートに `Secrets.toml` を作成し、以下の設定を記述してください。

```toml
# 本番環境（デプロイ先）のURL、Shuttle Consoleから確認してください
BASE_URL = "https://yourproject.shuttleapp.rs"

# 管理画面ログイン用のパスワード
ADMIN_PASSWORD = "ここに複雑なパスワードを設定"
```

### 2. ローカルでの実行
Dockerが起動していることを確認し、以下を実行します。

```bash
cargo shuttle run
```
ブラウザで `http://localhost:8000` にアクセスしてください。
※ローカル実行時、CSVログ等はPCのローカルタイムで出力されますが、本番環境の挙動とは異なる場合があります。

### 3. 本番環境へのデプロイ
Shuttleへのログイン・プロジェクト作成が完了している状態で以下を実行します。

```bash
cargo shuttle deploy
```

## 📱 使い方

### 管理者メニューへのアクセス
*   URL: `https://yourproject.shuttleapp.rs/`(Shuttle Consoleから確認してください)
*   初回アクセス時に認証が求められます。
    *   **ユーザー名**: `admin`
    *   **パスワード**: `Secrets.toml` で設定した値

### 各画面の役割
*   **発券画面**: 受付担当者が使用します。人数を入力して発券し、QRコードをお客様に提示してください。
*   **呼び出し管理**: 誘導・案内担当者が使用します。順番が来たら「呼び出し」を、案内が終わったら「完了」を押してください。
*   **管理メニュー**: CSVのダウンロードや、データの全消去（リセット）が行えます。

## 📊 ログデータとタイムゾーンについて

管理画面からダウンロードできるCSVファイル (`tickets_log.csv`) には、以下の時刻データが含まれます。

*   **発券時刻 (created_at)**
*   **呼出時刻 (called_at)**
*   **完了時刻 (completed_at)**

### ⚠️ タイムゾーンの注意点
Shuttleのサーバー（コンテナ）は標準で **UTC (協定世界時)** で動作しています。
そのため、ダウンロードしたCSV内の時刻は **UTC** で記録されています。

日本時間 (JST) で分析を行う際は、ExcelやGoogleスプレッドシート等の集計ソフト側で **+9時間** の補正を行ってください。

Example:
*   ログ記録: `10:00:00` (UTC)
*   日本時間: `19:00:00` (JST)

## 🔒 セキュリティ仕様
*   **認証**: 管理者エリア (`/admin/*`) はBasic認証により保護されています。
*   **CSRF対策**: POSTリクエスト（発券、状態更新、リセット）実行時、リクエスト元のドメイン（Origin/Referer）が `BASE_URL` と一致するか検証します。
*   **DB操作**: `sqlx` のプレースホルダを使用し、SQLインジェクションを防いでいます。

## 📜 ライセンス
This project is for educational purposes.

---
*Created for University Festival 202X*
